# Enhanced security headers
add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self'; frame-ancestors 'self';" always;

# Malicious bots and scrapers
map $http_user_agent $bad_bot {
    default 0;
    "~*(googlebot|bingbot|YandexBot|Applebot|DuckDuckBot)" 0;
    "~*(mj12bot|AhrefsBot|semrushbot|dotbot|petalbot|Bytespider|CCBot|DataForSeoBot|MegaIndex|ZoominfoBot)" 1;
    "~*(scrapy|curl|wget|python-requests|java|libwww)" 1;
    "~*(nmap|nikto|sqlmap|metasploit|burpsuite|nessus|openvas)" 1;
}

# SQL injection patterns
map $args $sql_injection {
    default 0;
    "~*(union\s+select|union\s+all\s+select|select.*from|insert\s+into|update.*set|delete\s+from|drop\s+table|create\s+table|exec\(|xp_cmdshell|load_file|outfile|dumpfile)" 1;
    "~*('|\"|;|--|/\*|\*/|@@|char\(|benchmark\(|sleep\(|waitfor\s+delay)" 1;
}

# XSS patterns
map $args $xss_attack {
    default 0;
    "~*(<script|javascript:|onload=|onerror=|onclick=|onmouseover=|alert\(|confirm\(|prompt\(|document\.cookie|window\.location|eval\(|expression\()" 1;
}

# Path traversal and directory traversal
map $request_uri $path_traversal {
    default 0;
    "~*(\.\./|\.\.\\|~/|\\|\.\.%2f|\.\.%5c|%2e%2e%2f|%252e%252e%252f)" 1;
}

# Command injection
map $args $command_injection {
    default 0;
    "~*(\\||&&|;|`|\$\(|\n|\r|whoami|id|uname|ls|dir|cat|echo|chmod|chown)" 1;
}

# File inclusion
map $args $lfi_rfi {
    default 0;
    "~*(\.\./|php://|zlib://|data://|expect://|phar://|file://|http://|https://|ftp://)" 1;
}

# Scanner detection
map $http_user_agent $scanner {
    default 0;
    "~*(acunetix|nikto|nessus|openvas|metasploit|sqlmap|w3af|zap|burp|nmap|skipfish|wikto)" 1;
}

# Malicious references
map $http_referer $bad_referer {
    default 0;
    "~*(semalt.com|buttons-for-website.com|social-buttons.com|simple-share-buttons.com)" 1;
}

# Only NEW zones that do not exist in nginx.conf
limit_req_zone $binary_remote_addr zone=scanners:10m rate=1r/m;
limit_req_zone $binary_remote_addr zone=admin:10m rate=2r/s;

# Log format for security
log_format security_json escape=json '{'
    '"timestamp": "$time_iso8601", '
    '"remote_addr": "$remote_addr", '
    '"request_method": "$request_method", '
    '"request_uri": "$request_uri", '
    '"status": "$status", '
    '"http_user_agent": "$http_user_agent", '
    '"http_referer": "$http_referer", '
    '"blocked_rule": "$blocked_rule", '
    '"query_string": "$query_string", '
    '"server_name": "$server_name", '
    '"component": "waf"'
'}';

# Variables for threat tracking
geo $limited_country {
    default 0;
}

# Hide Nginx version
server_tokens off;

# Prevent frame embedding
add_header X-Frame-Options "SAMEORIGIN" always;

# Prevent MIME sniffing
add_header X-Content-Type-Options "nosniff" always;

# Enable XSS filter
add_header X-XSS-Protection "1; mode=block" always;

# HSTS
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Referrer policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Content security policy
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self'; frame-ancestors 'self';" always;

# Permissions policy
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
